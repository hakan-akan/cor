#!/bin/sh
# we aren't using gdb's batch mode because it aborts on error *and detaches* (i.e. resumes),
# but we deliberately want to skip past the error, and explicitly disconnect without resuming.
# FIXME: the race condition in case qemu is slow. But i think gdb retries.

DEBUGFLAGS="-DWITH_DEBUG_TRAP" make clean all
qemu-system-x86_64 -d int,pcall,cpu_reset,ioport,unimp,guest_errors -s disk.bin -nographic -monitor stdio -serial stdio $QEMUOPT < /dev/null &
Q=$!
sleep 3
gdb --command scripts/stage2.gdb
kill $Q
